# Technical Requirements & API Integration

## External API Dependencies

### 1. Tavily Search API
**Purpose**: Primary search engine for academic literature discovery

**Key Endpoints Used**:
- `POST /search` - Execute searches across multiple academic sources

**Configuration**:
```typescript
interface TavilySearchParams {
  query: string;
  search_depth: 'basic' | 'advanced'; // Use 'advanced' for better academic results
  max_results: number; // 10-20 per search
  topic: 'general'; // Academic content
  include_answer: false; // We handle our own summarization
  include_raw_content: false; // Use Extract API separately
  include_domains?: string[]; // Focus on academic domains
}
```

**Academic Domain Targeting**:
```typescript
const ACADEMIC_DOMAINS = [
  'pubmed.ncbi.nlm.nih.gov',
  'arxiv.org', 
  'scholar.google.com',
  'ieee.org',
  'acm.org',
  'springer.com',
  'elsevier.com',
  'nature.com',
  'science.org'
];
```

**Search Strategy**:
- Each Explorer Agent makes multiple refined searches
- Start with broad terms, then narrow based on initial results
- Source credibility filtering based on reputation
- Relevance scoring for user's specific research question

### 2. Tavily Extract API
**Purpose**: Extract detailed content from specific academic papers

**Usage Pattern**:
- **Immediate**: Extract content from TOP most relevant paper automatically
- **On-Demand**: Extract content only when user clicks to view paper details
- **Database Strategy**: Save extracted content only after user views (to avoid unnecessary API costs)

**Configuration**:
```typescript
interface TavilyExtractParams {
  urls: string;
  extract_depth: 'advanced'; // Get tables, embedded content
  format: 'markdown'; // Better for academic content parsing
  include_images: false; // Focus on text content
}
```

## Database Architecture

### New Tables Required

#### 1. Research Sessions
```sql
CREATE TABLE research_sessions (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  user_id UUID NOT NULL REFERENCES users(id),
  query TEXT NOT NULL,
  research_questions JSONB NOT NULL, -- Questions generated by Lead Researcher
  status VARCHAR(50) NOT NULL DEFAULT 'active', -- active, completed, archived
  total_papers_found INTEGER DEFAULT 0,
  created_at TIMESTAMP NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMP NOT NULL DEFAULT NOW()
);
```

#### 2. Search Results (Papers)
```sql
CREATE TABLE search_results (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  session_id UUID NOT NULL REFERENCES research_sessions(id),
  agent_id VARCHAR(100) NOT NULL, -- Which Explorer Agent found this
  research_question_index INTEGER NOT NULL, -- Which question this answers
  
  -- Paper metadata (from Tavily API response)
  title TEXT NOT NULL,
  url TEXT NOT NULL,
  content_preview TEXT, -- Short snippet from Tavily
  favicon_url TEXT, -- Favicon URL from Tavily
  
  -- Tavily relevance scoring
  relevance_score INTEGER NOT NULL, -- 0-100
  
  -- Tavily metadata
  tavily_score DECIMAL,
  
  created_at TIMESTAMP NOT NULL DEFAULT NOW()
);
```

#### 3. Extracted Content (On-Demand)
```sql
CREATE TABLE extracted_content (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  search_result_id UUID NOT NULL REFERENCES search_results(id),
  
  -- Full extracted content from Tavily Extract API
  raw_content TEXT NOT NULL,
  abstract TEXT,
  methodology_details TEXT,
  findings_detailed TEXT,
  limitations TEXT,
  citations JSONB,
  
  -- Extraction metadata
  extract_depth VARCHAR(20) NOT NULL,
  extraction_successful BOOLEAN NOT NULL DEFAULT true,
  
  created_at TIMESTAMP NOT NULL DEFAULT NOW()
);
```

#### 4. Agent Status Tracking
```sql
CREATE TABLE agent_status (
  id UUID PRIMARY KEY DEFAULT gen_random_uuid(),
  session_id UUID NOT NULL REFERENCES research_sessions(id),
  agent_name VARCHAR(100) NOT NULL, -- Agent Alpha, Beta, etc.
  research_question TEXT NOT NULL,
  status VARCHAR(50) NOT NULL, -- queuing, searching, analyzing, complete
  progress_percentage INTEGER DEFAULT 0,
  current_action TEXT, -- "Searching PubMed for 'X'"
  papers_found INTEGER DEFAULT 0,
  
  created_at TIMESTAMP NOT NULL DEFAULT NOW(),
  updated_at TIMESTAMP NOT NULL DEFAULT NOW()
);
```

### Tables to Remove from Base Template

#### Remove Completely:
- `chat` - Not needed, replaced by research_sessions
- `message` / `Message_v2` - No chat interface
- `messageDeprecated` - Not needed
- `vote` / `Vote_v2` - No voting on papers
- `voteDeprecated` - Not needed
- `document` - No artifact creation
- `suggestion` - Different type of suggestions
- `stream` - No streaming chat interface

#### Keep from Base Template:
- `user` - Authentication still needed
- Modified authentication flow for research sessions

## API Routes Required

### Core Research Routes
```
POST /api/research/start
- Create new research session
- Trigger Lead Researcher Agent
- Return session ID and initial questions

GET /api/research/[sessionId]/status
- Get real-time agent progress
- Return agent statuses and partial results

GET /api/research/[sessionId]/results
- Get all search results for session
- Support pagination and filtering

POST /api/research/[sessionId]/extract
- Extract detailed content for specific paper
- Save to database after extraction
```

### Background Processing Routes
```
POST /api/agents/search
- Internal route for Explorer Agents
- Save search results to database
- Update agent status

POST /api/agents/extract
- Internal route for content extraction
- Called when user requests paper details
```

## Real-Time Updates

### WebSocket or Server-Sent Events
```typescript
interface AgentProgressUpdate {
  sessionId: string;
  agentName: string;
  status: 'queuing' | 'searching' | 'analyzing' | 'complete';
  progress: number; // 0-100
  currentAction: string;
  papersFound: number;
}

interface NewPaperFound {
  sessionId: string;
  paper: SearchResult;
  totalPapersCount: number;
}
```

## Environment Variables Required
```env
# Tavily API
TAVILY_API_KEY=tvly-your-api-key

# Existing from template
POSTGRES_URL=your-neon-db-url
AUTH_SECRET=your-auth-secret
NEXTAUTH_URL=your-domain
```

## Performance Considerations

### API Rate Limits
- Tavily Search: Monitor usage across parallel agents
- Implement exponential backoff for rate limit handling
- Queue management for multiple concurrent searches

### Database Optimization
- Index on session_id, user_id for fast lookups
- Partition research_sessions by created_at for historical data
- Cache frequently accessed search results

### Cost Management
- Extract API only called on user interaction
- Implement result caching to avoid duplicate searches
- Monitor and alert on API usage costs